---
title: "Trabajo Práctico Final"
author: "Gazze Simón, Moresi Manuel"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    self_contained: true
---

<style>
.math.display {
  font-size: 85%;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", warning = FALSE, message = FALSE)
options(scipen = 999)
```

```{r}
library(readxl)
library(ggplot2)
library(tidyverse)
library(patchwork)
library(moments)
library(MASS)
```

## Introducción

El margen mínimo de solvencia constituye uno de los pilares fundamentales en la supervisión y estabilidad financiera del mercado asegurador. Se trata de una exigencia regulatoria destinada a garantizar que las compañías de seguros cuenten con un respaldo económico suficiente para hacer frente a sus obligaciones futuras, incluso en escenarios adversos.

Determinar dicho margen con precisión es clave no solo para cumplir con las normativas vigentes, sino también para contribuir a la salud financiera de la entidad aseguradora, prevenir situaciones de Ruina Técnica, y garantizar la confianza de los asegurados.

En este trabajo, se calculará el margen mínimo de solvencia tal que la probabilidad de solvencia sea del 99% para una empresa aseguradora en el año 2024, en base a su cartera de pólizas y la información disponible sobre siniestros del año 2023. Para realizar dicho cálculo se tendrá que simular la distribución del número de siniestros en el año 2024 y la distribución de las cuantías individuales en dicho año.

## Análisis descriptivo

Para obtener un panorama real de una posible distribución de las cuantías individuales en el año 2024 en base a la información recolectada en el año 2023 se realizó un ajuste por inflación, utilizando la serie CER obtenida en la página del [Banco Central de la República Argentina](https://www.bcra.gob.ar/PublicacionesEstadisticas/Principales_variables_datos.asp?serie=3540&detalle=CER%A0(Base%2002/02/2002=1)). Dichas cuantías ajustadas se obtienen mediante la siguiente fórmula:

$$Cuantía_{2024} = \frac{CER(xx/xx/2024)}{CER(xx/xx/2023)} \times Cuantía_{2023}$$

A continuación se presenta la distribución de las cuantías actualizadas:

```{r}
df_cuantias <- read_excel("Trabajo Final 2024 Base de Datos .xlsx")

a = ggplot(df_cuantias, aes(x=`Cuantía actualizada`)) +
  geom_histogram(bins = 20, fill = "lightblue", color = "black")+
  labs(title = "Distribución de las cuantías ajustadas", y = "Frecuencia", x = "Cuantías")+
  theme_minimal()+
  theme(plot.title = element_text(size = 10,face = "bold", hjust = 0.5))

b = ggplot(df_cuantias)+
  aes(x=`Cuantía actualizada`)+
  geom_density(color = "blue4")+
  labs(title = "Densidad de las cuantías ajustadas", y = "Frecuencia", x = "Cuantías")+
  scale_x_continuous(breaks = c(0,4000000,8000000,12000000))+
  theme_minimal()+
  theme(plot.title = element_text(size = 10,face = "bold", hjust = 0.5))

a + b

```

Se observa una distribución muy asimétrica a la derecha, presentando algunos valores extremos cercanos a los 12 millones de pesos.

Además, se cuenta con la información de la cantidad de siniestros y de las cuantías totales para los años 2021,2022 y 2023. Se presentan a continuación:

```{r}
df <- data.frame(
  Año = c(2021, 2022, 2023),
  Pólizas = c(24752, 25348, 25615),
  Siniestros = c(3023, 3581, 3431)
)

# Pasamos de ancho a largo
df_long <- pivot_longer(df, cols = c(Pólizas, Siniestros),
                        names_to = "Tipo", values_to = "Cantidad")

# Gráfico de barras apiladas
ggplot(df_long, aes(x = factor(Año), y = Cantidad, fill = Tipo)) +
  geom_bar(stat = "identity", color = "black", position = "dodge") +
  labs(title = "Pólizas y Siniestros por año",
       x = "Año", y = "Cantidad") +
  scale_fill_manual(values = c("Pólizas" = "#1f77b4", "Siniestros" = "lightblue")) +
  theme_minimal() +
  theme(plot.title = element_text(size = 10,face = "bold", hjust = 0.5)) 
```

Se observan comportamientos similares en todos los años analizados.

Las proporciones de siniestros en cada año son las siguientes,

$$p_{2021} = \frac{3023}{24752} = 0.1221$$

$$p_{2022} = \frac{3581}{25348} = 0.1412$$

$$p_{2023} = \frac{3431}{25615} = 0.1339$$

Tal como se comentó anteriormente, se observan valores similares respecto a la proporción de siniestros por póliza en los años analizados, por lo que se podría suponer que en el año 2024 se va a mantener la cantidad de pólizas y el perfil de las mismas.

## Desarrollo

Para realizar el cálculo del Margen de Solvencia Mínimo se debe obtener la distribución aproximada de la cuantía total de los siniestros en el año 2024. Para obtener dicha distribución hay que calcular (también mediante aproximaciones) las distribuciones de:

-   **Número de siniestros ocurridos**, en base a la información de la cantidad de siniestros ocurridos en los años 2021,2022 y 2023.

-   **Cuantías individuales de los siniestros**, en base a la distribución ya conocida de las cuantías individuales en el año 2023.

Es decir, se simulará inicialmente el número de siniestros para un año y para esta cantidad de siniestros se simulará la cuantía de cada uno de ellos. Este procedimiento se repetirá para un gran número de años, peritiendo obtener así la distribución aproximada de la cuantía total.

Es importante aclarar que para cada uno de estos años simulados, se va a suponer que el número de pólizas es el mismo que las que se tienen en el año 2023, es decir, 25.615 pólizas.

### Propuesta 1 (Poisson - Log Normal)

Para esta primer propuesta, se utilizará la distribución de Poisson para simular el número de siniestros en 100.000 años, para posteriormente calcular la distribución de las cuantías individuales en cada uno de esos años.

En relación a lo visto anteriormente, el parámetro de la distribución Poisson ($E(N) = \lambda$, donde N es la cantidad de siniestros por póliza) será $\lambda = 0.135$.

```{r}
set.seed(123)
#siniestros1 = numeric(100000)

if(FALSE){for(i in 1:100000){ 
siniestros1[i] <- sum(rpois(n = 25615, lambda = 0.135))

}}

#saveRDS(siniestros1, file = "siniestros1.rds")
siniestros1 <- readRDS("siniestros1.rds")


if(FALSE){df_siniestros1 <- bind_rows(
  lapply(seq_along(siniestros1), function(i) {
    data.frame(valor = siniestros1[[i]])
  })
)}

#saveRDS(df_siniestros1, file = "df_siniestros1.rds")
df_siniestros1 <- readRDS("df_siniestros1.rds")

ggplot(df_siniestros1)+
  aes(x=valor)+
  geom_histogram(bins = 20, color = "black", fill = "lightblue")+
  labs(title = "Distribución de las cantidades de siniestros simuladas", y = "Frecuencia", x = "Siniestros")+
  theme_minimal()+
  theme(plot.title = element_text(size = 10,face = "bold",hjust = 0.5))

```
Se observa una distribución simétrica, con un valor medio de 3457 siniestros y un desvío estándar de 59 siniestros.

Ahora se calculará la cuantía individual de cada uno de los siniestros en cada año, a partir de una distribución Log Normal, con $\mu = 944.906,6$ y $\sigma = 572.011,2$:

```{r}
set.seed(1)

log_media <- mean(log(df_cuantias$`Cuantía actualizada`))
log_desvio <- sd(log(df_cuantias$`Cuantía actualizada`))

#simulaciones <- vector("list", length(siniestros1))

if(FALSE){for(i in 1:length(siniestros1)) {
  simulaciones[[i]] <- rlnorm(siniestros1[i], meanlog = log_media, sdlog = log_desvio)
}}


#simulaciones <- readRDS("simulaciones.rds")

#muestra_100 <- sample(simulaciones, size = 100)

#saveRDS(muestra_100, file = "muestra_100.rds")

muestra_100 <- readRDS("muestra_100.rds")

df_muestra <- bind_rows(
  lapply(seq_along(muestra_100), function(i) {
    data.frame(valor = muestra_100[[i]], grupo = paste0("Dist_", i))
  })
)

ggplot(df_muestra, aes(x = valor, group = grupo)) +
  geom_density(size = 0.8, alpha = 0.7, color = "#1f77b4") +
  labs(title = "Densidades de 100 distribuciones simuladas",
       x = "Valor simulado", y = "Densidad") +
  theme_minimal() +
  theme(plot.title = element_text(size = 10,face = "bold", hjust = 0.5)) 
```

Una vez obtenidas las cuantías individuales para cada año simulado, se sumarán dichas cuantías para obtener valores de 100.000 cuantías totales, formando así una distribución simulada de la misma:

```{r}
#totales <- data.frame(totales = sapply(simulaciones, sum))

#saveRDS(totales, file = "totales.rds")

totales <- readRDS("totales.rds")

a1 = ggplot(totales)+
  aes(x=totales)+
  geom_histogram(bins = 20, color = "black", fill = "lightblue")+
  labs(title = "Distribución de las cuantías totales simuladas", y = "Frecuencia", x = "Cuantías totales")+
  theme_minimal()+
  theme(plot.title = element_text(size = 9,face = "bold"),axis.text.x = element_text(size = 8))

b1 = ggplot(totales)+
  aes(x=totales)+
  geom_density(color = "#1f77b4")+
  labs(title = "Densidad de las cuantías totales simuladas", y = "Frecuencia", x = "Cuantías totales")+
  theme_minimal()+
  theme(plot.title = element_text(size = 9,face = "bold"),axis.text.x = element_text(size = 8))

a1 + b1

#skewness(totales$totales)
#mean(totales$totales)
#sd(totales$totales)
```

La distribución simulada presenta un comportamiento parecido a la Normal, y al calcular el coeficiente de asimetría muestral se obtiene un valor de $0.028$. Por este motivo, el cálculo del Margen de Solvencia Mínimo se calculará mediante una aproximación Normal de las cuantías totales con $\mu = 3.249.248.925$ y $\sigma = 61.547.862$.

#### Margen de Solvencia Mínimo

Para este cálculo se va a tener que definir de antemano la prima recargada (PR) que se va a cobrar al cliente, con recargos de seguridad distintos, 1% y 3%.

Para que la probabilidad de solvencia sea del 99%, se necesita conocer el valor de la Normal Estandar que acumula el 99% de probabilidad.

$$ Z \sim  N(0,1)  \rightarrow P(Z < z_0) = 0.99 \rightarrow z_0 = 2.326$$

-   Para un *recargo de seguridad (R) del 1%*:

$$E(Y) = 3.249.248.925 , \ SD(Y) = 61.547.862 , \ R = E(Y) \times 0.01 = 32.492.489 , \ PR = E(Y) + R = 3.281.741.414$$

Entonces el monto total a cobrar al cliente para garantizar una solvencia del 99% es:

$$ y_0 = 3.249.248.925 + 2.326*61.547.862 = 3.392.409.252 $$

Y el **Margen de Solvencia Mínimo** resulta:

$$MSM = y_0 - PR = 3.392.409.252 - 3.281.741.414 = 110.667.838$$

-   Para un *recargo de seguridad (R) del 3%*:


$$E(Y) = 3.249.248.925 , \ SD(Y) = 61.547.862 , \ R = E(Y) \times 0.03 = 97.477.468 , \ PR = E(Y) + R = 3.346.726.393$$


Entonces el monto total a cobrar al cliente para garantizar una solvencia del 99% es:


$$ y_0 = 3.249.248.925 + 2.326*61.547.862 = 3.392.409.252 $$


Y el **Margen de Solvencia Mínimo** resulta:

$$MSM = y_0 - PR = 3.392.409.252 - 3.346.726.393 = 45.682.859$$

### Propuesta 2 (Poisson - Weibull)

Para esta propuesta, se utilizará nuevamente la distribución de Poisson para simular el número de siniestros en 100.000 años, para posteriormente calcular la distribución de las cuantías individuales en cada uno de esos años.

Nuevamente, el parámetro de la distribución Poisson ($E(N) = \lambda$, donde N es la cantidad de siniestros por póliza) será $\lambda = 0.135$.

```{r}
set.seed(124)
#siniestros2 = numeric(100000)

if(FALSE){for(i in 1:100000){ 
siniestros2[i] <- sum(rpois(n = 25615, lambda = 0.135))

}}

#saveRDS(siniestros2, file = "siniestros2.rds")
siniestros2 <- readRDS("siniestros2.rds")


if(FALSE){df_siniestros2 <- bind_rows(
  lapply(seq_along(siniestros2), function(i) {
    data.frame(valor = siniestros2[[i]])
  })
)}

#saveRDS(df_siniestros2, file = "df_siniestros2.rds")
df_siniestros2 <- readRDS("df_siniestros2.rds")

ggplot(df_siniestros2)+
  aes(x=valor)+
  geom_histogram(bins = 20, color = "black", fill = "lightblue")+
  labs(title = "Distribución de las cantidades de siniestros simuladas", y = "Frecuencia", x = "Siniestros")+
  theme_minimal()+
  theme(plot.title = element_text(size = 10,face = "bold",hjust = 0.5))

```
Nuevamente se observa una distribución de los siniestros muy simétrica, con un valor medio de 3458 siniestros y un desvío estandar de 59 siniestros.

Ahora se calculará la cuantía individual de cada uno de los siniestros en cada año, a partir de una distribuciónde Weibull, con $\alpha = 165346.3$ y $\beta = 0.614$. Dicha estimación de los parámetros se realizó mediante el *método de máxima verosimilitud*:

```{r}
set.seed(2)

fit <- fitdistr(df_cuantias$`Cuantía actualizada`, "weibull")

simulaciones2 <- vector("list", length(siniestros2))

if (FALSE) {for(i in 1:length(siniestros2)) {
  simulaciones2[[i]] <- rweibull(siniestros2[i], shape = 1.79472, scale = 1052668.59354)
}} 

#muestra2_100 <- sample(simulaciones2, size = 100)

#saveRDS(muestra2_100, file = "muestra2_100.rds")

muestra2_100 <- readRDS("muestra2_100.rds")

df_muestra2 <- bind_rows(
  lapply(seq_along(muestra2_100), function(i) {
    data.frame(valor = muestra2_100[[i]], grupo = paste0("Dist_", i))
  })
)

ggplot(df_muestra2, aes(x = valor, group = grupo)) +
  geom_density(size = 0.8, alpha = 0.7, color = "#1f77b4") +
  labs(title = "Densidades de 100 distribuciones simuladas",
       x = "Valor simulado", y = "Densidad") +
  theme_minimal() +
  theme(plot.title = element_text(size = 10,face = "bold", hjust = 0.5)) 
```

Esta distribución simulada de las cuantías individuales presenta un comportamiento menos asimétrico que la distribución obtenida en la *Propuesta 1*, también se observa una cola menos pesada, es decir, no presenta valores tan extremos de las cuantías.

Una vez obtenidas las cuantías individuales para cada año simulado, se sumarán dichas cuantías para obtener valores de 100.000 cuantías totales, formando así una distribución simulada de la misma:

```{r}
#totales2 <- data.frame(totales2 = sapply(simulaciones2, sum))

#saveRDS(totales2, file = "totales2.rds")

totales2 <- readRDS("totales2.rds")

a2 = ggplot(totales2)+
  aes(x=totales2)+
  geom_histogram(bins = 20, color = "black", fill = "lightblue")+
  labs(title = "Distribución de las cuantías totales simuladas", y = "Frecuencia", x = "Cuantías totales")+
  scale_x_continuous(breaks = c(3000000000,3200000000,3400000000))+
  theme_minimal()+
  theme(plot.title = element_text(size = 9,face = "bold"), axis.text.x = element_text(size = 8))

b2 = ggplot(totales2)+
  aes(x=totales2)+
  geom_density(color = "#1f77b4")+
  labs(title = "Densidad de las cuantías totales simuladas", y = "Frecuencia", x = "Cuantías totales")+
  scale_x_continuous(breaks = c(3000000000,3200000000,3400000000))+
  theme_minimal()+
  theme(plot.title = element_text(size = 9,face = "bold"), axis.text.x = element_text(size = 8))

a2 + b2

#skewness(totales2$totales2)
#mean(totales2$totales2)
#sd(totales2$totales2)
```

Al realizar las 100.000 simulaciones, se observa que la distribución resultante se asemeja a una distribición Normal, con un coeficiente de asimetría muestral igual a $-0.0012$. Por lo tanto, el Margen de Solvencia Mínimo se calculará mediante una aproximación Normal de las cuantías totales con $\mu = 3.237.807.477$ y $\sigma = 63.682.695$.

#### Margen de Solvencia Mínimo

Para ser consistentes con lo trabajado anteriormente, se utilizarán recargos de seguridad del 1% y 3%.

Para que la probabilidad de solvencia sea del 99%, se necesita conocer el valor de la Normal Estandar que acumula el 99% de probabilidad.

$$ Z \sim  N(0,1)  \rightarrow P(Z < z_0) = 0.99 \rightarrow z_0 = 2.326$$

-   Para un *recargo de seguridad (R) del 1%*:

$$E(Y) = 3.237.807.477 , \ SD(Y) = 63.682.695 , \ R = E(Y) \times 0.01 = 32.378.075 , \ PR = E(Y) + R = 3.270.185.552$$

Entonces el monto total a cobrar al cliente para garantizar una solvencia del 99% es:

$$ y_0 = 3.237.807.477 + 2.326*63.682.695 = 3.385.933.426 $$

Y el Margen de Solvencia Mínimo resulta:

$$MSM = y_0 - PR = 3.385.933.426 - 3.270.185.552 = 115.747.874$$

-   Para un *recargo de seguridad (R) del 3%*:

$$E(Y) = 3.237.807.477 , \ SD(Y) = 63.682.695 , \ R = E(Y) \times 0.03 = 97.134.224 , \ PR = E(Y) + R = 3.334.941.701$$

Entonces el monto total a cobrar al cliente para garantizar una solvencia del 99% es:

$$ y_0 = 3.237.807.477 + 2.326*63.682.695 = 3.385.933.426 $$

Y el Margen de Solvencia Mínimo resulta:

$$MSM = y_0 - PR = 3.385.933.426 - 3.334.941.701 = 50.991.725$$
